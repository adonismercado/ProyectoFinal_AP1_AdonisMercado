@page "/deshabilitados"
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout

@inject PedidoServices pedidoServices
@inject DistribuidorServices distribuidorServices
@inject ToastService toastService
@rendermode InteractiveServer

<PageTitle>Deshabilitados</PageTitle>

<div class="container-fluid py-4">

	<div class="text-center mb-3">
		<h2 class="fw-bold">
			@(tabSeleccionado == 0 ? "Distribuidores Deshabilitados" : "Pedidos Deshabilitados")
		</h2>
	</div>

	<div class="d-flex justify-content-center mb-4">
		<ul class="nav nav-tabs" id="deshabilitadosTabs" style="max-width: 500px;">
			<li class="nav-item">
				<button class="nav-link @(tabSeleccionado == 0 ? "active" : "")"
						@onclick="() => CambiarTab(0)">
					<i class="fa fa-users"></i> Distribuidores
				</button>
			</li>

			<li class="nav-item">
				<button class="nav-link @(tabSeleccionado == 1 ? "active" : "")"
						@onclick="() => CambiarTab(1)">
					<i class="fa fa-box"></i> Pedidos
				</button>
			</li>
		</ul>
	</div>

	<div class="card shadow-sm border-0 mx-auto" style="max-width: 1500px;">
		<div class="card-body">

			@if (tabSeleccionado == 0)
			{
				<div class="table-responsive">
					<table class="table table-hover text-center align-middle mb-0">
						<thead class="table-light fw-bold">
							<tr>
								<th>ID</th>
								<th>Nombre</th>
								<th>Email</th>
								<th>Teléfono</th>
								<th>Fax</th>
								<th>Acción</th>
							</tr>
						</thead>

						<tbody>
							@foreach (var d in ListaDistribuidores)
							{
								<tr>
									<td>@d.DistribuidorId</td>
									<td>@d.Nombre</td>
									<td>@d.Email</td>
									<td>@d.Telefono</td>
									<td>@d.Fax</td>
									<td>
										<div class="d-flex justify-content-center gap-2">

											<button class="btn btn-success"
													@onclick="() => HabilitarDistribuidor(d.DistribuidorId)">
												<i class="fa fa-check"></i>
											</button>

											<button class="btn btn-danger"
													@onclick="() => EliminarDistribuidor(d.DistribuidorId)">
												<i class="fa-solid fa-trash"></i>
											</button>

										</div>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}

			@if (tabSeleccionado == 1)
			{
				<div class="table-responsive">
					<table class="table table-hover text-center align-middle mb-0">
						<thead class="table-light fw-bold">
							<tr>
								<th>Fecha</th>
								<th>ID</th>
								<th>Nombre Pedido</th>
								<th>Estado</th>
								<th>Distribuidor</th>
								<th>Acción</th>
							</tr>
						</thead>

						<tbody>
							@foreach (var p in ListaPedidos)
							{
								<tr>
									<td>@p.FechaPedido.ToShortDateString()</td>
									<td>@p.PedidoId</td>
									<td>@p.NombrePedido</td>
									<td>@p.Estado</td>
									<td>@p.Distribuidor?.Nombre</td>

									<td>
										<div class="d-flex justify-content-center gap-2">

											<button class="btn btn-success"
													@onclick="() => HabilitarPedido(p.PedidoId)">
												<i class="fa fa-check"></i>
											</button>

											<button class="btn btn-danger"
													@onclick="() => EliminarPedido(p.PedidoId)">
												<i class="fa-solid fa-trash"></i>
											</button>

										</div>
									</td>

								</tr>
							}
						</tbody>
					</table>
				</div>
			}

		</div>
	</div>

</div>

@code {
	private int tabSeleccionado = 0;

	public List<Pedido> ListaPedidos { get; set; } = new();
	public List<Distribuidor> ListaDistribuidores { get; set; } = new();

	protected override async Task OnInitializedAsync()
	{
		ListaPedidos = await pedidoServices.ListarPedidos(p => !p.isActive);
		ListaDistribuidores = await distribuidorServices.ListarDistribuidores(d => !d.isActive);
	}

	private void CambiarTab(int index)
	{
		tabSeleccionado = index;
	}

	public async Task HabilitarPedido(int pedidoId)
	{
		var ok = await pedidoServices.Habilitar(pedidoId);
		if (ok)
		{
			ListaPedidos = await pedidoServices.ListarPedidos(p => !p.isActive);
			toastService.ShowSuccess("Pedido habilitado!");
		}
		else
		{
			toastService.ShowError("Error al habilitar pedido");
		}
	}

	public async Task HabilitarDistribuidor(int distribuidorId)
	{
		var ok = await distribuidorServices.Habilitar(distribuidorId);
		if (ok)
		{
			ListaDistribuidores = await distribuidorServices.ListarDistribuidores(d => !d.isActive);
			toastService.ShowSuccess("Distribuidor habilitado!");
		}
		else
		{
			toastService.ShowError("Error al habilitar distribuidor");
		}
	}

	public async Task EliminarPedido(int pedidoId)
	{
		var ok = await pedidoServices.Eliminar(pedidoId);
		if (ok)
		{
			ListaPedidos = await pedidoServices.ListarPedidos(p => !p.isActive);
			toastService.ShowSuccess("Pedido eliminado!");
		}
		else
		{
			toastService.ShowError("No se pudo eliminar");
		}
	}

	public async Task EliminarDistribuidor(int distribuidorId)
	{
		var ok = await distribuidorServices.Eliminar(distribuidorId);
		if (ok)
		{
			ListaDistribuidores = await distribuidorServices.ListarDistribuidores(d => !d.isActive);
			toastService.ShowSuccess("Distribuidor eliminado!");
		}
		else
		{
			toastService.ShowError("No se pudo eliminar");
		}
	}
}
