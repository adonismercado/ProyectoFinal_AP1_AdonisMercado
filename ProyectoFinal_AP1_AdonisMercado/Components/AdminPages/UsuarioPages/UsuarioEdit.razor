@page "/usuarios/edit/{Id}"
@attribute [Authorize(Roles = "Admin")]
@layout EmptyLayout

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager nav
@inject ToastService toastService
@rendermode InteractiveServer

<PageTitle>Editar Usuario</PageTitle>
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            <i class="fa-solid fa-user-pen me-2"></i> Editar Usuario
        </h2>

        <a href="/usuarios" class="btn btn-light">
            <i class="fa-solid fa-arrow-left me-2"></i> Volver
        </a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-4">
            <EditForm Model="@Form" OnValidSubmit="Guardar" FormName="EditUsuario">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-3">
                    <label class="form-label fw-bold">Email</label>
                    <input type="text" class="form-control" @bind="Form.Email" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Cambiar Contraseña</label>
                    <input type="text" class="form-control" @bind="Form.NewPassword" />
                    <small class="text-muted">D&eacute;jalo vacio si no desea cambiar la contraseña.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Rol</label>
                    <select class="form-select" @bind="Form.Role">
                        @foreach (var r in Roles)
                        {
                            <option value="@r">@r</option>
                        }
                    </select>
                </div>

                @if (!string.IsNullOrWhiteSpace(errorMensaje))
                {
                    <div class="alert alert-danger">@errorMensaje</div>
                }

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-danger px-4">
                        <i class="fa-solid fa-floppy-disk me-2"></i> Guardar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; } = "";

    public class UsuarioForm
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        public string Role { get; set; } = "";

        public string? NewPassword { get; set; }
    }

    public UsuarioForm Form = new();
    public List<string> Roles = new();
    public string errorMensaje = "";

    private ApplicationUser? usuario;

    protected override async Task OnInitializedAsync()
    {
        Roles = await RoleManager.Roles
            .Select(r => r.Name!)
            .ToListAsync();

        usuario = await UserManager.FindByIdAsync(Id);

        if (usuario == null)
        {
            nav.NavigateTo("/usuarios", forceLoad: true);
            return;
        }

        var roles = await UserManager.GetRolesAsync(usuario);

        Form.Email = usuario.Email;
        Form.Role = roles.FirstOrDefault() ?? "User";
    }

    private async Task Guardar()
    {
        if (usuario == null)
        {
            toastService.ShowError("Usuario no encontrado.");
            errorMensaje = "Usuario no encontrado.";
            return;
        }

        usuario.Email = Form.Email;
        usuario.UserName = Form.Email;

        var result = await UserManager.UpdateAsync(usuario);
        if (!result.Succeeded)
        {
            toastService.ShowError("Error al editar el usuario.");
            errorMensaje = "Error al editar el usuario.";
            return;
        }

        var currentRoles = await UserManager.GetRolesAsync(usuario);
        await UserManager.RemoveFromRolesAsync(usuario, currentRoles);
        await UserManager.AddToRoleAsync(usuario, Form.Role);

        if(!string.IsNullOrWhiteSpace(Form.NewPassword))
        {
            var token = await UserManager.GeneratePasswordResetTokenAsync(usuario);
            var passResult = await UserManager.ResetPasswordAsync(usuario, token, Form.NewPassword);

            if (!passResult.Succeeded)
            {
                toastService.ShowError("Error al intentar cambiar la contraseña");
                errorMensaje = "Error al intentar cambiar la contraseña.";
                return;
            }
        }

        toastService.ShowSuccess("Usuario modificado exitosamente!");
        nav.NavigateTo("/usuarios", forceLoad: true);
    } 
}