@page "/vehiculos/create"
@attribute [Authorize(Roles = "Admin")]
@layout EmptyLayout

@inject VehiculoService vehiculoService
@inject CloudflareR2Service r2Service
@inject NavigationManager nav
@inject ToastService toastService
@rendermode InteractiveServer

<PageTitle>Crear Vehículo</PageTitle>

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Crear Veh&iacute;culo</h2>

        <a href="/vehiculos" class="btn btn-light d-flex align-items-center gap-2">
            <i class="fa-solid fa-arrow-left"></i> Volver
        </a>
    </div>

    <div class="card shadow border-0 w-100" style="width: 100%;">
        <div class="card-body p-4">

            <EditForm Model="@Vehiculo" OnValidSubmit="Guardar" FormName="CreateVehiculo">
                <DataAnnotationsValidator />

                <div class="d-flex flex-column">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Vehículo ID</label>
                        <input type="number" class="form-control" @bind="Vehiculo.VehiculoId" readonly />
						<ValidationMessage For="() => Vehiculo.VehiculoId" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Marca</label>
                        <input type="text" class="form-control" @bind="Vehiculo.MarcaVehiculo" />
						<ValidationMessage For="() => Vehiculo.MarcaVehiculo" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Modelo</label>
                        <input type="text" class="form-control" @bind="Vehiculo.ModeloVehiculo" />
						<ValidationMessage For="() => Vehiculo.ModeloVehiculo" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Color</label>
                        <input type="text" class="form-control" @bind="Vehiculo.ColorVehiculo" />
						<ValidationMessage For="() => Vehiculo.ColorVehiculo" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Chasis</label>
                        <input type="text" class="form-control" @bind="Vehiculo.NumeroChasis" />
						<ValidationMessage For="() => Vehiculo.NumeroChasis" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Año Fabricación</label>
                        <input type="number" class="form-control" @bind="Vehiculo.AnioFabricacion" />
						<ValidationMessage For="() => Vehiculo.AnioFabricacion" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Motor</label>
                        <input type="text" class="form-control" @bind="Vehiculo.Motor" />
						<ValidationMessage For="() => Vehiculo.Motor" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Transmisión</label>
                        <input type="text" class="form-control" @bind="Vehiculo.Transmision" />
						<ValidationMessage For="() => Vehiculo.Transmision" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tracción</label>
                        <input type="text" class="form-control" @bind="Vehiculo.Traccion" />
						<ValidationMessage For="() => Vehiculo.Traccion" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Número Puertas</label>
                        <input type="number" class="form-control" @bind="Vehiculo.NumeroPuertas" />
						<ValidationMessage For="() => Vehiculo.NumeroPuertas" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Kilometraje</label>
                        <input type="number" class="form-control" @bind="Vehiculo.Kilometraje" />
						<ValidationMessage For="() => Vehiculo.Kilometraje" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado</label>
                        <input type="text" class="form-control" @bind="Vehiculo.EstadoVehiculo" />
						<ValidationMessage For="() => Vehiculo.EstadoVehiculo" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo Combustible</label>
                        <input type="text" class="form-control" @bind="Vehiculo.TipoCombustible" />
						<ValidationMessage For="() => Vehiculo.TipoCombustible" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Precio</label>
                        <input type="number" class="form-control" @bind="Vehiculo.Precio" />
						<ValidationMessage For="() => Vehiculo.Precio" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Imagen del Vehículo</label>
                        <InputFile class="form-control"
                                   OnChange="OnImagenSelected"
                                   accept="image/*" />
                    </div>

                </div>

                <div class="text-center mt-4">
                    <button class="btn btn-danger px-4">
                        <i class="fa-solid fa-floppy-disk me-2"></i> Guardar
                    </button>
                </div>

            </EditForm>

        </div>
    </div>
</div>

@code {
    public Vehiculo Vehiculo { get; set; } = new();
    private IBrowserFile? ImagenArchivo;

    private async Task OnImagenSelected(InputFileChangeEventArgs e)
    {
        ImagenArchivo = e.File;
    }

    private async Task Guardar()
    {
        Vehiculo.isActive = true;
        var nuevoId = await vehiculoService.InsertarConId(Vehiculo);

        if (nuevoId <= 0)
        {
            toastService.ShowError("Error al crear el vehículo.");
            return;
        }

        if (ImagenArchivo != null)
        {
            var urlImagen = await r2Service.SubirArchivo(ImagenArchivo, "vehiculos", nuevoId.ToString());

            if (!string.IsNullOrEmpty(urlImagen))
            {
                await vehiculoService.ActualizarImagen(nuevoId, urlImagen);
            }
        }

        toastService.ShowSuccess("Vehículo creado exitosamente!");
        nav.NavigateTo("/vehiculos", forceLoad: true);
    }
}