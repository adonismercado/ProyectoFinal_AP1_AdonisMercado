@page "/vehiculos"
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout

@inject VehiculoService vehiculoService
@inject NavigationManager nav
@inject ToastService toastService
@rendermode InteractiveServer

<PageTitle>Vehículos</PageTitle>

<div class="container-fluid py-4">

	<div class="text-center mb-3">
		<h2 class="fw-bold">Vehículos</h2>
	</div>

	<div class="card shadow-sm border-0 mx-auto" style="max-width:1500px;">

		<div class="card-header bg-white py-3">

			<div class="row g-3 align-items-end">

				<div class="col-md-3">
					<label class="form-label fw-bold">Filtrar por</label>
					<select class="form-select" @bind="Filtro">
						<option value="" disabled selected>Seleccione...</option>
						<option value="VehiculoId">ID</option>
						<option value="Marca">Marca</option>
						<option value="Modelo">Modelo</option>
						<option value="Color">Color</option>
						<option value="NumeroChasis">Número Chasis</option>
						<option value="AnioFabricacion">Año Fabricación</option>
						<option value="Motor">Motor</option>
						<option value="Transmision">Transmisión</option>
						<option value="Traccion">Tracción</option>
						<option value="NumeroPuertas">Puertas</option>
						<option value="Kilometraje">Kilometraje</option>
						<option value="Combustible">Combustible</option>
						<option value="Precio">Precio</option>
					</select>
				</div>

				<div class="col-md-4">
					<label class="form-label fw-bold">Buscar</label>
					<div class="input-group">
						<input type="text" class="form-control" @bind="ValorFiltro" placeholder="Buscar..." />
						<button class="btn btn-outline-danger" @onclick="Buscar">
							<i class="fa-solid fa-magnifying-glass"></i>
						</button>
					</div>
				</div>

				<div class="col-md-3 d-flex align-items-end">
					<div class="form-check mt-4">
						<input class="form-check-input" type="checkbox" id="chkDeshabilitados"
							   @bind="mostrarDeshabilitados" @bind:after="OnToggleDeshabilitados" />
						<label class="form-check-label fw-bold" for="chkDeshabilitados">
							Mostrar deshabilitados
						</label>
					</div>
				</div>

				<div class="col-md-2 d-flex justify-content-end">
					<a href="/vehiculos/create" class="btn btn-danger px-3">
						<i class="fa-solid fa-plus me-2"></i> Agregar Vehículo
					</a>
				</div>
			</div>
		</div>

		<div class="card-body px-0">
			<div class="table-responsive">
				<table class="table table-hover text-center align-middle mb-0">

					<thead class="table-light fw-bold">
						<tr>
							<th>ID</th>
							<th>Marca</th>
							<th>Modelo</th>
							<th>Color</th>
							<th>Chasis</th>
							<th>Año</th>
							<th>Motor</th>
							<th>Transmisión</th>
							<th>Tracción</th>
							<th>Puertas</th>
							<th>Kilometraje</th>
							<th>Condición</th>
							<th>Combustible</th>
							<th>Precio</th>
							<th>Estado</th>
							<th>Acciones</th>
						</tr>
					</thead>

					<tbody>
						@foreach (var v in ListaVehiculos)
						{
							<tr>
								<td>@v.VehiculoId</td>
								<td>@v.MarcaVehiculo</td>
								<td>@v.ModeloVehiculo</td>
								<td>@v.ColorVehiculo</td>
								<td>@v.NumeroChasis</td>
								<td>@v.AnioFabricacion</td>
								<td>@v.Motor</td>
								<td>@v.Transmision</td>
								<td>@v.Traccion</td>
								<td>@v.NumeroPuertas</td>
								<td>@v.Kilometraje</td>
								<td>@v.EstadoVehiculo</td>
								<td>@v.TipoCombustible</td>
								<td>USD$@v.Precio</td>

								<td>
									@if (v.isActive)
									{
										<span class="badge bg-danger">Activo</span>
									}
									else
									{
										<span class="badge bg-secondary">Inactivo</span>
									}
								</td>

								<td>
									<div class="d-flex justify-content-center gap-2">

										@if (v.isActive)
										{
											<a class="btn btn-warning text-white"
											   href="/vehiculos/edit/@v.VehiculoId">
												<i class="fa-solid fa-pen-to-square"></i>
											</a>

											<button class="btn btn-danger"
													@onclick="() => AbrirDeshabilitar(v)">
												<i class="fa-solid fa-ban"></i>
											</button>
										}
										else
										{
											<button class="btn btn-secondary"
													@onclick="() => AbrirHabilitar(v)">
												<i class="fa-solid fa-check"></i>
											</button>

											<button class="btn btn-danger"
													@onclick="() => AbrirEliminar(v)">
												<i class="fa-solid fa-trash"></i>
											</button>
										}

									</div>
								</td>
							</tr>
						}
					</tbody>

				</table>
			</div>
		</div>

		<div class="card-footer text-center bg-white py-3">
			Mostrando @ListaVehiculos.Count vehiculo(s)
		</div>

	</div>
</div>



@if (mostrarDeshabilitar)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">Deshabilitar Vehículo</h5>
					<button class="btn-close" @onclick="CerrarDeshabilitar"></button>
				</div>

				<div class="modal-body text-center">
					<i class="fa-solid fa-triangle-exclamation text-danger" style="font-size: 55px;"></i>
					<p class="mt-3 fs-5">¿Desea deshabilitar este vehículo?</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" @onclick="CerrarDeshabilitar">Cancelar</button>
					<button class="btn btn-danger" @onclick="Deshabilitar">Deshabilitar</button>
				</div>
			</div>
		</div>
	</div>
}

@if (mostrarHabilitar)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">Habilitar Vehículo</h5>
					<button class="btn-close" @onclick="CerrarHabilitar"></button>
				</div>

				<div class="modal-body text-center">
					<i class="fa-solid fa-circle-check text-success" style="font-size: 55px;"></i>
					<p class="mt-3 fs-5">¿Desea habilitar este vehículo?</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" @onclick="CerrarHabilitar">Cancelar</button>
					<button class="btn btn-danger" @onclick="Habilitar">Habilitar</button>
				</div>

			</div>
		</div>
	</div>
}

@if (mostrarEliminar)
{
	<div class="modal fade show d-block" style="background:rgba(0,0,0,0.6);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div class="modal-header">
					<h5>Eliminar vehículo</h5>
					<button class="btn-close" @onclick="CerrarEliminar"></button>
				</div>

				<div class="modal-body text-center">
					<i class="fa-solid fa-trash text-danger" style="font-size:55px;"></i>
					<p class="mt-3 fw-bold">¿Eliminar este vehículo de forma permanente?</p>
					<p class="text-muted">Esta acción no se puede deshacer.</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" @onclick="CerrarEliminar">Cancelar</button>
					<button class="btn btn-danger" @onclick="Eliminar">Eliminar</button>
				</div>

			</div>
		</div>
	</div>
}

@code {
	public List<Vehiculo> ListaVehiculos { get; set; } = new();

	public string Filtro { get; set; } = "";
	public string ValorFiltro { get; set; } = "";

	public Vehiculo? vehiculoSeleccionado;
	public bool mostrarDeshabilitar = false;
	public bool mostrarHabilitar = false;
	public bool mostrarEliminar = false;
	public bool mostrarDeshabilitados = false;

	protected override async Task OnInitializedAsync()
	{
		await CargarLista();
	}

	public async Task CargarLista()
	{
		ListaVehiculos = await vehiculoService.ListarVehiculos(
			v => v.isActive != mostrarDeshabilitados
		);

		if (!string.IsNullOrWhiteSpace(ValorFiltro))
		{ 
			await Buscar(); 
		}
	}

	private async Task OnToggleDeshabilitados()
	{
		await CargarLista();
	}

	public async Task Buscar()
	{

		bool activo = !mostrarDeshabilitados;

		if (!string.IsNullOrWhiteSpace(ValorFiltro))
		{
			if (Filtro == "VehiculoId" && int.TryParse(ValorFiltro, out var vehiculoId))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.VehiculoId == vehiculoId && v.isActive == activo);
			}
			else if (Filtro == "Marca")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.MarcaVehiculo.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Modelo")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.ModeloVehiculo.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Color")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.ColorVehiculo.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "NumeroChasis")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.NumeroChasis.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "AnioFabricacion" && int.TryParse(ValorFiltro, out var anio))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.AnioFabricacion == anio && v.isActive == activo);
			}
			else if (Filtro == "Motor")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Motor.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Transmision")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Transmision.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Traccion")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Traccion.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "NumeroPuertas" && int.TryParse(ValorFiltro, out var puertas))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.NumeroPuertas == puertas && v.isActive == activo);
			}
			else if (Filtro == "Kilometraje" && int.TryParse(ValorFiltro, out var kilometraje))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Kilometraje == kilometraje && v.isActive == activo);
			}
			else if (Filtro == "Combustible")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.TipoCombustible.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Precio" && decimal.TryParse(ValorFiltro, out var precio))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Precio == precio && v.isActive == activo);
			}
		}
		else
		{
			await CargarLista();
		}
	}

	public void AbrirDeshabilitar(Vehiculo v)
	{
		vehiculoSeleccionado = v;
		mostrarDeshabilitar = true;
	}

	public void AbrirHabilitar(Vehiculo v)
	{
		vehiculoSeleccionado = v;
		mostrarHabilitar = true;
	}

	public void CerrarDeshabilitar()
	{
		mostrarDeshabilitar = false;
	}

	public void CerrarHabilitar()
	{
		mostrarHabilitar = false;
	}

	public void AbrirEliminar(Vehiculo v)
	{
		vehiculoSeleccionado = v;
		mostrarEliminar = true;
	}

	public void CerrarEliminar()
	{
		mostrarEliminar = false;
	}

	public async Task Deshabilitar()
	{
		var deshabilitado = await vehiculoService.Deshabilitar(vehiculoSeleccionado!.VehiculoId);
		if (deshabilitado)
		{
			mostrarDeshabilitar = false;
			await CargarLista();
			toastService.ShowSuccess("Vehiculo deshabilitado exitosamente!");
		}
		else
		{
			mostrarDeshabilitar = false;
			toastService.ShowError("No se pudo deshabilitar el vehiculo.");
		}
	}

	public async Task Habilitar()
	{
		var habilitado = await vehiculoService.Habilitar(vehiculoSeleccionado!.VehiculoId);
		if (habilitado)
		{
			mostrarHabilitar = false;
			await CargarLista();
			toastService.ShowSuccess("Vehiculo habilitado exitosamente!");
		}
		else
		{
			mostrarHabilitar = false;
			toastService.ShowError("No se pudo habilitar el vehiculo.");
		}
	}

	public async Task Eliminar()
	{
		var eliminado = await vehiculoService.Eliminar(vehiculoSeleccionado!.VehiculoId);
		if (eliminado)
		{
			mostrarEliminar = false;
			await CargarLista();
			toastService.ShowSuccess("Vehiculo eliminado exitosamente!");
		}
		else
		{
			mostrarEliminar = false;
			toastService.ShowError("No se pudo eliminar el vehiculo.");
		}
	}
}
