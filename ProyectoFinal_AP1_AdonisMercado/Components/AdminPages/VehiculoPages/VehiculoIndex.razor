@page "/vehiculos"
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout

@inject VehiculoService vehiculoService
@inject NavigationManager nav
@rendermode InteractiveServer

<PageTitle>Veh&iacute;culos</PageTitle>
<div class="container-fluid py-4">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2 class="fw-bold">Vehículos</h2>

		<a href="/admin" class="btn btn-light">
			<i class="fa-solid fa-house me-2"></i> Inicio
		</a>
	</div>

	<div class="card shadow-sm border-0">
		<div class="card-header bg-white py-3">

			<div class="row g-3 align-items-end">
				<div class="col-md-3">
					<label class="form-label fw-bold">Filtrar por</label>
					<select class="form-select" @bind="Filtro">
						<option value="" disabled selected>Seleccione...</option>
						<option value="VehiculoId">ID</option>
						<option value="Marca">Marca</option>
						<option value="Modelo">Modelo</option>
						<option value="Color">Color</option>
						<option value="NumeroChasis">N&uacute;mero Chasis</option>
						<option value="AnioFabricacion">Año Fabricaci&oacute;n</option>
						<option value="Motor">Motor</option>
						<option value="Transmision">Transmisi&oacute;n</option>
						<option value="Traccion">Tracci&oacute;n</option>
						<option value="NumeroPuertas">Puertas</option>
						<option value="Kilometraje">Kilometraje</option>
						<option value="Combustible">Combustible</option>
						<option value="Precio">Precio</option>
					</select>
				</div>

				<div class="col-md-4">
					<label class="form-label fw-bold">Buscar</label>
					<div class="input-group">
						<input type="text" class="form-control" @bind="ValorFiltro" placeholder="Buscar..." />
						<button class="btn btn-danger" @onclick="Buscar">
							<i class="fa-solid fa-magnifying-glass"></i>
						</button>
					</div>
				</div>

                <div class="col-md-3 d-flex align-items-center mt-4">
                    <input type="checkbox" class="form-check-input me-2"
							id="chkDeshabilitados"
                           @bind="mostrarDeshabilitados"
						   @bind:after="OnToggleDeshabilitados" />
                    <label for="chkDeshabilitados" class="form-check-label fw-bold">
                        Mostrar deshabilitados
                    </label>
                </div>

				<div class="col-md-2 text-end">
					<a href="/vehiculos/create" class="btn btn-danger">
						<i class="fa-solid fa-plus me-2"></i> Agregar Vehículo
					</a>
				</div>
			</div>
		</div>

		<div class="card-body px-0">
			<div class="table-responsive">
				<table class="table table-hover align-middle mb-0">
					<thead class="bg-light">
						<tr class="text-center fw-bold">
							<th>ID</th>
							<th>Marca</th>
							<th>Modelo</th>
							<th>Color</th>
							<th>Chasis</th>
							<th>Año</th>
							<th>Motor</th>
							<th>Transmisi&oacute;n</th>
							<th>Tracci&oacute;n</th>
							<th>Puertas</th>
							<th>Kilometraje</th>
							<th>Condici&oacute;n</th>
							<th>Combustible</th>
							<th>Precio</th>
							<th>Estado</th>
							<th>Acciones</th>
						</tr>
					</thead>

					<tbody class="text-center">
						@foreach (var v in ListaVehiculos)
						{
							<tr class="text-center">
								<td>@v.VehiculoId</td>
								<td>@v.MarcaVehiculo</td>
								<td>@v.ModeloVehiculo</td>
								<td>@v.ColorVehiculo</td>
								<td>@v.NumeroChasis</td>
								<td>@v.AnioFabricacion</td>
								<td>@v.Motor</td>
								<td>@v.Transmision</td>
								<td>@v.Traccion</td>
								<td>@v.NumeroPuertas</td>
								<td>@v.Kilometraje</td>
								<td>@v.EstadoVehiculo</td>
								<td>@v.TipoCombustible</td>
								<td>@v.Precio</td>
								<td>
									@if (v.isActive)
									{
										<span class="badge bg-danger">Activo</span>
									}
									else
									{
										<span class="badge bg-secondary">Inactivo</span>
									}
								</td>

								<td>
									<div class="d-flex justify-content-center gap-2">
										<a class="btn btn-sm btn-warning me-2 text-white"
										   href="/vehiculos/edit/@v.VehiculoId">
											<i class="fa-solid fa-pen-to-square"></i>
										</a>

										@if (v.isActive)
										{
											<button class="btn btn-sm btn-danger"
													@onclick="() => AbrirDeshabilitar(v)">
												<i class="fa-solid fa-trash"></i>
											</button>
										}
										else
										{
											<button class="btn btn-sm btn-secondary"
													@onclick="() => AbrirHabilitar(v)">
												<i class="fa-solid fa-user-check"></i>
											</button>

											<button class="btn btn-sm btn-danger"
													@onclick="() => AbrirEliminar(v)">
												<i class="fa-solid fa-trash"></i>
											</button>
										}
									</div>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		</div>

		<div class="card-footer text-center">
			Mostrando @ListaVehiculos.Count() vehiculo(s)
		</div>
	</div>
</div>

@if (mostrarDeshabilitar)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">Deshabilitar Vehículo</h5>
					<button class="btn-close" @onclick="CerrarDeshabilitar"></button>
				</div>

				<div class="modal-body text-center">
					<i class="fa-solid fa-triangle-exclamation text-danger" style="font-size: 55px;"></i>
					<p class="mt-3 fs-5">¿Desea deshabilitar este vehículo?</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" @onclick="CerrarDeshabilitar">Cancelar</button>
					<button class="btn btn-danger" @onclick="Deshabilitar">Deshabilitar</button>
				</div>
			</div>
		</div>
	</div>
}

@if (mostrarHabilitar)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">Habilitar Vehículo</h5>
					<button class="btn-close" @onclick="CerrarHabilitar"></button>
				</div>

				<div class="modal-body text-center">
					<i class="fa-solid fa-circle-check text-success" style="font-size: 55px;"></i>
					<p class="mt-3 fs-5">¿Desea habilitar este vehículo?</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" @onclick="CerrarHabilitar">Cancelar</button>
					<button class="btn btn-danger" @onclick="Habilitar">Habilitar</button>
				</div>

			</div>
		</div>
	</div>
}

@if (mostrarEliminar)
{
	<div class="modal fade show d-block" style="background:rgba(0,0,0,0.6);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div class="modal-header">
					<h5>Eliminar vehículo</h5>
					<button class="btn-close" @onclick="CerrarEliminar"></button>
				</div>

				<div class="modal-body text-center">
					<i class="fa-solid fa-trash text-danger" style="font-size:55px;"></i>
					<p class="mt-3 fw-bold">¿Eliminar este vehículo de forma permanente?</p>
					<p class="text-muted">Esta acción no se puede deshacer.</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" @onclick="CerrarEliminar">Cancelar</button>
					<button class="btn btn-danger" @onclick="Eliminar">Eliminar</button>
				</div>

			</div>
		</div>
	</div>
}

@code {
	public List<Vehiculo> ListaVehiculos { get; set; } = new();

	public string Filtro { get; set; } = "";
	public string ValorFiltro { get; set; } = "";

	public Vehiculo? vehiculoSeleccionado;
	public bool mostrarDeshabilitar = false;
	public bool mostrarHabilitar = false;
	public bool mostrarEliminar = false;
	public bool mostrarDeshabilitados = false;

	protected override async Task OnInitializedAsync()
	{
		await CargarLista();
	}

	public async Task CargarLista()
	{
		ListaVehiculos = await vehiculoService.ListarVehiculos(
			v => v.isActive != mostrarDeshabilitados
		);

		if (!string.IsNullOrWhiteSpace(ValorFiltro))
		{ 
			await Buscar(); 
		}
	}

	private async Task OnToggleDeshabilitados()
	{
		await CargarLista();
	}

	public async Task Buscar()
	{

		bool activo = !mostrarDeshabilitados;

		if (!string.IsNullOrWhiteSpace(ValorFiltro))
		{
			if (Filtro == "VehiculoId" && int.TryParse(ValorFiltro, out var vehiculoId))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.VehiculoId == vehiculoId && v.isActive == activo);
			}
			else if (Filtro == "Marca")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.MarcaVehiculo.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Modelo")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.ModeloVehiculo.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Color")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.ColorVehiculo.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "NumeroChasis")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.NumeroChasis.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "AnioFabricacion" && int.TryParse(ValorFiltro, out var anio))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.AnioFabricacion == anio && v.isActive == activo);
			}
			else if (Filtro == "Motor")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Motor.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Transmision")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Transmision.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Traccion")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Traccion.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "NumeroPuertas" && int.TryParse(ValorFiltro, out var puertas))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.NumeroPuertas == puertas && v.isActive == activo);
			}
			else if (Filtro == "Kilometraje" && int.TryParse(ValorFiltro, out var kilometraje))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Kilometraje == kilometraje && v.isActive == activo);
			}
			else if (Filtro == "Combustible")
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.TipoCombustible.ToLower().Contains(ValorFiltro) && v.isActive == activo);
			}
			else if (Filtro == "Precio" && decimal.TryParse(ValorFiltro, out var precio))
			{
				ListaVehiculos = await vehiculoService.ListarVehiculos(v => v.Precio == precio && v.isActive == activo);
			}
		}
		else
		{
			await CargarLista();
		}
	}

	public void AbrirDeshabilitar(Vehiculo v)
	{
		vehiculoSeleccionado = v;
		mostrarDeshabilitar = true;
	}

	public void AbrirHabilitar(Vehiculo v)
	{
		vehiculoSeleccionado = v;
		mostrarHabilitar = true;
	}

	public void CerrarDeshabilitar()
	{
		mostrarDeshabilitar = false;
	}

	public void CerrarHabilitar()
	{
		mostrarHabilitar = false;
	}

	public void AbrirEliminar(Vehiculo v)
	{
		vehiculoSeleccionado = v;
		mostrarEliminar = true;
	}

	public void CerrarEliminar()
	{
		mostrarEliminar = false;
	}

	public async Task Deshabilitar()
	{
		var deshabilitado = await vehiculoService.Deshabilitar(vehiculoSeleccionado!.VehiculoId);
		if (deshabilitado)
		{
			mostrarDeshabilitar = false;
			await CargarLista();
		}
	}

	public async Task Habilitar()
	{
		var habilitado = await vehiculoService.Habilitar(vehiculoSeleccionado!.VehiculoId);
		if (habilitado)
		{
			mostrarHabilitar = false;
			await CargarLista();
		}
	}

	public async Task Eliminar()
	{
		var eliminado = await vehiculoService.Eliminar(vehiculoSeleccionado!.VehiculoId);
		if (eliminado)
		{
			mostrarEliminar = false;
			await CargarLista();
		}
	}
}
